<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
      @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css');
      :root { --main-bg: #f8f9fa; --card-bg: #ffffff; --text-primary: #212529; --text-secondary: #6c757d; --key-color-1: #dc8d32; --key-color-2: #0f2e69; --border-color: #dee2e6; --font-family: 'Pretendard', sans-serif; }
      body { font-family: var(--font-family); background-color: var(--main-bg); color: var(--text-primary); margin: 0; padding: 2rem; }
      .container { max-width: 1200px; margin: 0 auto; }
      .header { margin-bottom: 2rem; }
      .header-top { display: flex; justify-content: space-between; align-items: flex-start; }
      .header h1 { font-size: 2rem; font-weight: 700; color: var(--key-color-2); margin-bottom: 0.5rem; }
      .header p { color: var(--text-secondary); margin-top: 0; }
      #crawlButton { font-family: var(--font-family); font-size: 1rem; font-weight: 600; background-color: var(--key-color-1); color: white; border: none; border-radius: 8px; padding: 0.8rem 1.5rem; cursor: pointer; transition: background-color 0.2s; }
      #crawlButton:disabled { background-color: #ccc; cursor: not-allowed; }
      #crawlStatus { font-size: 0.9rem; color: var(--text-secondary); height: 20px; margin-top: 0.5rem;}
      .search-bar { display: flex; gap: 1rem; margin-top: 1.5rem; }
      .search-bar input { flex-grow: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
      .search-bar button { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background-color: var(--key-color-2); color: white; font-size: 1rem; cursor: pointer; }
      .section { margin-bottom: 3rem; }
      .section-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; }
      .section-header h2 { font-size: 1.5rem; font-weight: 600; margin: 0; }
      .tag { background-color: var(--key-color-1); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.9rem; font-weight: 500; }
      .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
      .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 0.75rem; }
      .card-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-secondary); }
      .card-category { background-color: #e9ecef; padding: 0.2rem 0.6rem; border-radius: 8px; font-weight: 500; color: var(--key-color-2); }
      .card-title { font-size: 1.1rem; font-weight: 600; margin: 0; }
      .card-summary { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; }
      .card-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; }
      .impact-badge { padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem; font-weight: 700; }
      .impact-badge.high { background-color: #fff5f5; color: #e53e3e; } .impact-badge.medium { background-color: #fffbeb; color: #f59e0b; } .impact-badge.low { background-color: #f0fdf4; color: #16a34a; }
      .card-link a { text-decoration: none; color: var(--key-color-1); font-weight: 500; font-size: 0.9rem; }
      .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; }
      .stat-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; }
      .stat-card .label { font-size: 1rem; color: var(--text-secondary); }
      .stat-card .value { font-size: 2.5rem; font-weight: 700; color: var(--key-color-2); margin: 0.5rem 0; }
    </style>
</head>
<body>
    <div class="container">
      <header class="header">
        <div class="header-top">
          <div>
            <h1>인프라 투자 동향 대시보드</h1>
            <p>인프라 투자 관련 주요 규제 및 정책 변경사항을 실시간으로 모니터링하고 분석하세요.</p>
          </div>
          <div>
            <button id="crawlButton">🔄 실시간 정보 업데이트</button>
            <p id="crawlStatus"></p>
          </div>
        </div>
        <div class="search-bar"><input type="text" id="searchInput" placeholder="보고서 제목, 카테고리, 내용으로 검색..."><button id="searchButton">검색</button></div>
      </header>
      <section class="section" id="search-results-section" style="display: none;"><div class="section-header"><h2 id="search-results-title">검색 결과</h2></div><div class="card-grid" id="search-results-grid"></div></section>
      <section class="section" id="today-section"><div class="section-header"><h2>오늘의 주요 변경사항</h2><span class="tag" id="today-count">0</span></div><div class="card-grid" id="today-grid"><p>데이터를 불러오는 중입니다...</p></div></section>
      <section class="section"><div class="stats-grid" id="stats-grid"><div class="stat-card"><div class="label">전체 보고서</div><div class="value" id="total-reports">0</div></div><div class="stat-card"><div class="label">신규 업데이트 (오늘)</div><div class="value" id="new-updates">0</div></div><div class="stat-card"><div class="label">높은 임팩트</div><div class="value" id="high-impact">0</div></div><div class="stat-card"><div class="label">분석 카테고리</div><div class="value" id="total-categories">0</div></div></div></section>
      <section class="section"><div class="section-header"><h2 id="recent-title">최근 보고서</h2></div><div class="card-grid" id="recent-grid"></div></section>
    </div>
    <script>
      // <<<--- 웹 앱 로직 시작 --->>>
      document.addEventListener('DOMContentLoaded', loadDashboard);
      document.getElementById('searchButton').addEventListener('click', handleSearch);
      document.getElementById('searchInput').addEventListener('keyup', (event) => { if (event.key === 'Enter') handleSearch(); });
      document.getElementById('crawlButton').addEventListener('click', handleCrawl);

      function handleCrawl() {
        const crawlButton = document.getElementById('crawlButton');
        const crawlStatus = document.getElementById('crawlStatus');
        
        crawlButton.disabled = true;
        crawlStatus.textContent = '업데이트 중... (최대 1-2분 소요)';
        
        google.script.run
          .withSuccessHandler(onCrawlSuccess)
          .withFailureHandler(showError)
          .runCrawlingFromWebApp();
      }

      function onCrawlSuccess(message) {
        const crawlButton = document.getElementById('crawlButton');
        const crawlStatus = document.getElementById('crawlStatus');

        crawlStatus.textContent = message;
        crawlButton.disabled = false;
        
        // 업데이트된 데이터를 다시 불러와 화면을 갱신합니다.
        loadDashboard();

        // 5초 후에 상태 메시지를 지웁니다.
        setTimeout(() => { crawlStatus.textContent = ''; }, 5000);
      }
      
      function loadDashboard() { google.script.run.withSuccessHandler(updateUI).withFailureHandler(showError).getDashboardData(); }
      function updateUI(data) {
        const todayGrid = document.getElementById('today-grid');
        document.getElementById('today-count').textContent = data.stats.today;
        todayGrid.innerHTML = data.todayReports.length > 0 ? data.todayReports.map(r => createCard(r, true)).join('') : "<p>오늘의 신규 업데이트가 없습니다.</p>";
        document.getElementById('total-reports').textContent = data.stats.total;
        document.getElementById('new-updates').textContent = data.stats.today;
        document.getElementById('high-impact').textContent = data.stats.highImpact;
        document.getElementById('total-categories').textContent = data.stats.categories;
        document.getElementById('recent-grid').innerHTML = data.recentReports.map(r => createCard(r, false)).join('');
      }
      function handleSearch() {
        const searchTerm = document.getElementById('searchInput').value, searchSection = document.getElementById('search-results-section'), searchGrid = document.getElementById('search-results-grid'), searchTitle = document.getElementById('search-results-title');
        if (!searchTerm) { searchSection.style.display = 'none'; return; }
        searchSection.style.display = 'block'; searchGrid.innerHTML = "<p>검색 중입니다...</p>"; searchTitle.textContent = `'${searchTerm}' 검색 결과`;
        google.script.run.withSuccessHandler(results => { searchGrid.innerHTML = results.length > 0 ? results.map(r => createCard(r, false)).join('') : "<p>검색 결과가 없습니다.</p>"; }).withFailureHandler(showError).searchReports(searchTerm);
      }
      function showError(error) { 
        alert('오류가 발생했습니다: ' + error.message); 
        const crawlButton = document.getElementById('crawlButton');
        const crawlStatus = document.getElementById('crawlStatus');
        crawlButton.disabled = false;
        crawlStatus.textContent = '오류 발생. 다시 시도해주세요.';
      }
      function createCard(report, isNew) {
        let impactClass = 'low'; if (report.impactLevel === '높음') impactClass = 'high'; else if (report.impactLevel === '중간') impactClass = 'medium';
        return `<div class="card"><div class="card-header"><span class="card-category">${report.category}</span>${isNew ? `<span>✨ 신규</span>` : ''}</div><h3 class="card-title">${report.title}</h3><p class="card-summary">${report.summary}</p><div class="card-footer"><span class="impact-badge ${impactClass}">${report.impactLevel} 임팩트</span><span class="card-link"><a href="${report.sourceURL}" target="_blank">원문 보기 &rarr;</a></span></div></div>`;
      }
    </script>
</body>
</html>
