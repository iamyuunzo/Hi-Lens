<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RegWatch - 인프라 투자 규제 모니터링</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #fafafa;
      color: #333;
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* 사이드바 */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 320px;
      height: 100vh;
      background: white;
      color: #333;
      z-index: 1000;
      transform: translateX(-100%);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 20px rgba(0,0,0,0.1);
    }

    .sidebar.active {
      transform: translateX(0);
      box-shadow: 2px 0 30px rgba(0,0,0,0.15);
    }

    .sidebar-header {
      padding: 25px 20px;
      border-bottom: 1px solid #e5e7eb;
      background: linear-gradient(135deg, #fafafa, #f8f9fa);
      position: relative;
    }

    .sidebar-logo h2 {
      color: #0f2e69;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .sidebar-subtitle {
      color: #6b7280;
      font-size: 12px;
    }

    .sidebar-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      color: #6b7280;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .sidebar-close:hover {
      background: #f3f4f6;
      color: #374151;
    }

    .new-chat-btn {
      margin: 20px;
      padding: 12px 20px;
      background: linear-gradient(135deg, #dc8d32, #f4a942);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      transform: translateY(0);
      box-shadow: 0 2px 10px rgba(220, 141, 50, 0.2);
    }

    .new-chat-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(220, 141, 50, 0.3);
    }

    /* 홈 버튼 추가 */
    .home-btn {
      margin: 0 20px 10px 20px;
      padding: 12px 20px;
      background: white;
      color: #0f2e69;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      text-align: center;
    }

    .home-btn:hover {
      background: #f8f9fa;
      border-color: #0f2e69;
      transform: translateY(-1px);
    }

    /* 대화 히스토리 */
    .conversation-history {
      flex: 1;
      padding: 0 20px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #d1d5db #f9fafb;
    }

    .conversation-history::-webkit-scrollbar {
      width: 6px;
    }

    .conversation-history::-webkit-scrollbar-track {
      background: #f9fafb;
    }

    .conversation-history::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .conversation-item {
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      opacity: 0;
      animation: slideInLeft 0.5s ease forwards;
      border: 1px solid transparent;
    }

    .conversation-item:hover {
      background: #f8f9fa;
      border-color: #e5e7eb;
      transform: translateX(3px);
    }

    .conversation-item.active {
      background: linear-gradient(135deg, #dc8d32, #f4a942);
      color: white;
      border-color: #dc8d32;
    }

    .conversation-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-time {
      font-size: 11px;
      color: #6b7280;
    }

    .conversation-item.active .conversation-time {
      color: rgba(255,255,255,0.8);
    }

    .delete-conversation {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      opacity: 0;
      transition: all 0.3s ease;
      font-size: 16px;
    }

    .conversation-item:hover .delete-conversation {
      opacity: 1;
    }

    .delete-conversation:hover {
      color: #ef4444;
    }

    /* 메뉴 섹션 */
    .menu-section {
      border-top: 1px solid #e5e7eb;
      padding: 20px;
      background: #fafafa;
    }

    .menu-title {
      color: #6b7280;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
    }

    .nav-menu {
      list-style: none;
    }

    .nav-item {
      margin-bottom: 8px;
    }

    .nav-link {
      display: block;
      padding: 12px 15px;
      color: #374151;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
      font-size: 14px;
      border: 1px solid transparent;
    }

    .nav-link:hover {
      background: white;
      border-color: #e5e7eb;
      color: #0f2e69;
      transform: translateX(3px);
    }

    /* 메인 컨테이너 */
    .main-container {
      margin-left: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .main-container.sidebar-open {
      margin-left: 320px;
    }

    /* 헤더 */
    .header {
      background: white;
      padding: 15px 30px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      height: 70px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .menu-toggle {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #374151;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .menu-toggle:hover {
      background: #f3f4f6;
      color: #0f2e69;
    }

    .hyundai-logo {
      height: 35px;
      background: linear-gradient(135deg, #ff8c00, #ffa500);
      padding: 8px 16px;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .hyundai-logo:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(255, 140, 0, 0.3);
    }

    .service-name {
      color: #0f2e69;
      font-size: 18px;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-info {
      color: #6b7280;
      font-size: 14px;
      padding: 8px 16px;
      background: #f8f9fa;
      border-radius: 20px;
      border: 1px solid #e5e7eb;
    }

    .mypage-btn {
      background: white;
      color: #0f2e69;
      border: 1px solid #e5e7eb;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .mypage-btn:hover {
      background: #f8f9fa;
      border-color: #0f2e69;
    }

    .logout-btn {
      background: linear-gradient(135deg, #dc8d32, #f4a942);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(220, 141, 50, 0.3);
    }

    /* 페이지 컨테이너 */
    .page-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* 랜딩페이지 */
    .landing-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: calc(100vh - 70px);
      padding: 40px 30px;
      text-align: center;
      opacity: 1;
      transform: translateY(0);
      transition: all 0.6s ease;
    }

    .landing-page.hidden {
      opacity: 0;
      transform: translateY(-30px);
      pointer-events: none;
    }

    .ai-badge {
      display: inline-block;
      background: linear-gradient(135deg, #dc8d32, #f4a942);
      color: white;
      padding: 10px 25px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 30px;
      animation: pulse 2s infinite;
      box-shadow: 0 4px 20px rgba(220, 141, 50, 0.3);
    }

    .main-title {
      font-size: 48px;
      font-weight: 700;
      color: #0f2e69;
      margin-bottom: 20px;
      line-height: 1.2;
      animation: fadeInUp 0.8s ease;
    }

    .highlight {
      background: linear-gradient(135deg, #dc8d32, #f4a942);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .main-description {
      font-size: 18px;
      color: #6b7280;
      margin-bottom: 40px;
      max-width: 600px;
      animation: fadeInUp 0.8s ease 0.2s both;
    }

    /* 검색 섹션 - 챗봇 스타일 줄임 */
    .search-section {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 60px;
      max-width: 700px;
      width: 100%;
      animation: fadeInUp 0.8s ease 0.4s both;
      border: 1px solid #e5e7eb;
    }

    .search-container {
      display: flex;
      gap: 15px;
    }

    .search-input {
      flex: 1;
      padding: 16px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
      background: #fafafa;
    }

    .search-input:focus {
      border-color: #dc8d32;
      background: white;
      box-shadow: 0 0 0 3px rgba(220, 141, 50, 0.1);
    }

    .search-btn {
      background: linear-gradient(135deg, #dc8d32, #f4a942);
      color: white;
      border: none;
      padding: 16px 28px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .search-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(220, 141, 50, 0.3);
    }

    /* 현업 니즈 섹션 */
    .business-sections {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .section-title {
      font-size: 28px;
      font-weight: 700;
      color: #0f2e69;
      margin-bottom: 30px;
      text-align: left;
    }

    /* 오늘의 주요 변경사항 */
    .daily-updates {
      margin-bottom: 60px;
    }

    .update-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .update-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .update-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.1);
      border-color: #dc8d32;
    }

    .update-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(135deg, #dc8d32, #f4a942);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .card-category {
      background: #f0f9ff;
      color: #0f2e69;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .card-impact {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .card-impact.high {
      background: #fef2f2;
      color: #dc2626;
    }

    .card-impact.medium {
      background: #fefbf2;
      color: #d97706;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .card-summary {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #9ca3af;
    }

    .effect-date {
      font-weight: 600;
      color: #dc8d32;
    }

    /* 주간 보고서 */
    .weekly-reports {
      margin-bottom: 40px;
    }

    .report-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .report-item {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .report-item:hover {
      transform: translateX(4px);
      border-color: #dc8d32;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .report-title {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      flex: 1;
    }

    .report-date {
      font-size: 12px;
      color: #6b7280;
      background: #f8f9fa;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .report-summary {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.5;
    }

    /* 채팅 페이지 - 가려짐 문제 해결 */
    .chat-page {
      display: none;
      height: calc(100vh - 70px);
      opacity: 0;
      transition: all 0.6s ease;
    }

    .chat-page.active {
      display: flex;
      flex-direction: column;
      opacity: 1;
    }

    /* 채팅 메시지 영역 - 패딩 조정으로 가려짐 해결 */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      scroll-behavior: smooth;
      background: #fafafa;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .messages-container {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 20px;
      min-height: 100%;
    }

    .message {
      opacity: 0;
      animation: messageSlideIn 0.5s ease forwards;
    }

    .message.user {
      align-self: flex-end;
    }

    .message.ai {
      align-self: flex-start;
    }

    .message-content {
      max-width: 70%;
      padding: 16px 20px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #dc8d32, #f4a942);
      color: white;
      border-bottom-right-radius: 6px;
    }

    .message.ai .message-content {
      background: white;
      color: #374151;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 6px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .message-time {
      font-size: 11px;
      color: rgba(255,255,255,0.7);
      margin-top: 6px;
    }

    .message.ai .message-time {
      color: #9ca3af;
    }

    /* 채팅 입력창 */
    .chat-input-container {
      background: white;
      border-top: 1px solid #e5e7eb;
      padding: 20px;
      flex-shrink: 0;
    }

    .chat-input-wrapper {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      transition: all 0.3s ease;
      background: #fafafa;
    }

    .chat-input:focus {
      border-color: #dc8d32;
      background: white;
      box-shadow: 0 0 0 3px rgba(220, 141, 50, 0.1);
    }

    .send-btn {
      background: linear-gradient(135deg, #dc8d32, #f4a942);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      height: 44px;
      flex-shrink: 0;
    }

    .send-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(220, 141, 50, 0.3);
    }

    .send-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* 타이핑 인디케이터 */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px 20px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 18px;
      border-bottom-left-radius: 6px;
      max-width: 70%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: #dc8d32;
      border-radius: 50%;
      animation: typingDot 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    /* 오버레이 */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.3);
      z-index: 999;
      backdrop-filter: blur(2px);
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* 애니메이션 */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes messageSlideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes typingDot {
      0%, 60%, 100% { transform: scale(1); opacity: 0.5; }
      30% { transform: scale(1.2); opacity: 1; }
    }

    /* 반응형 */
    @media (max-width: 768px) {
      .sidebar { width: 280px; }
      .main-container.sidebar-open { margin-left: 0; }
      .main-title { font-size: 36px; }
      .search-container { flex-direction: column; }
      .message-content { max-width: 85%; }
      .header { padding: 15px 20px; }
      .service-name { font-size: 16px; }
      .update-cards { grid-template-columns: 1fr; }
      .business-sections { padding: 0 15px; }
    }
  </style>
</head>
<body>
  <!-- 사이드바 오버레이 -->
  <div class="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- 사이드바 -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <h2>RegWatch</h2>
        <div class="sidebar-subtitle">AI 규제 분석 도우미</div>
      </div>
      <button class="sidebar-close" onclick="closeSidebar()">×</button>
    </div>
    
    <button class="new-chat-btn" onclick="startNewChat()">+ 새로운 대화</button>
    <button class="home-btn" onclick="goToHome()">🏠 홈으로 이동</button>
    
    <div class="conversation-history" id="conversationHistory">
      <!-- 대화 히스토리가 여기에 동적으로 추가됩니다 -->
    </div>
    
    <div class="menu-section">
      <div class="menu-title">도구</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="redirectToTool('dashboard')">📊 검색 기반 분석 대시보드</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="redirectToTool('reports')">📋 보고서 요약 카드</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" onclick="redirectToTool('compare')">🔍 국내외의 규제 비교분석</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- 메인 컨테이너 -->
  <div class="main-container" id="mainContainer">
    <!-- 헤더 -->
    <header class="header">
      <div class="header-left">
        <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
        <div class="hyundai-logo" onclick="goToHome()">현대해상</div>
        <span class="service-name">인프라 투자 규제 모니터링</span>
      </div>
      <div class="header-right">
        <span class="user-info">안녕하세요, 조용주님</span>
        <button class="mypage-btn" onclick="goToMyPage()">마이페이지</button>
        <button class="logout-btn" onclick="logout()">로그아웃</button>
      </div>
    </header>

    <!-- 페이지 컨테이너 -->
    <div class="page-container">
      <!-- 랜딩페이지 -->
      <div class="landing-page" id="landingPage">
        <div class="ai-badge">⚡ AI 기반 규제 분석 솔루션</div>
        
        <h1 class="main-title">
          인프라 투자 규제를<br>
          <span class="highlight">실시간으로 분석</span>
        </h1>
        
        <p class="main-description">
          신재생 에너지 정책부터 국내외 규제 변화까지, 복잡한 규제 환경을 AI가 쉽게 정리해드립니다
        </p>

        <!-- 검색 섹션 -->
        <div class="search-section">
          <div class="search-container">
            <input 
              type="text" 
              class="search-input" 
              id="searchInput"
              placeholder="예: 국내 해외 풍력발전 규제 비교해줘"
            >
            <button class="search-btn" id="searchBtn" onclick="startAnalysis()">분석 시작</button>
          </div>
        </div>

        <!-- 현업 니즈 섹션 -->
        <div class="business-sections">
          <!-- 오늘의 주요 변경사항 -->
          <div class="daily-updates">
            <h2 class="section-title">📋 오늘의 주요 변경사항</h2>
            <div class="update-cards" id="dailyUpdateCards">
              <!-- 동적으로 생성됩니다 -->
            </div>
          </div>

          <!-- 일주일 내 신규 업데이트 보고서 -->
          <div class="weekly-reports">
            <h2 class="section-title">📊 일주일 내 신규 업데이트 보고서</h2>
            <div class="report-list" id="weeklyReportList">
              <!-- 동적으로 생성됩니다 -->
            </div>
          </div>
        </div>
      </div>

      <!-- 채팅 페이지 -->
      <div class="chat-page" id="chatPage">
        <!-- 메시지 영역 -->
        <div class="chat-messages" id="chatMessages">
          <div class="messages-container" id="messagesContainer">
            <!-- 메시지들이 여기에 동적으로 추가됩니다 -->
          </div>
        </div>
        
        <!-- 입력창 -->
        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <textarea 
              class="chat-input" 
              id="chatInput"
              placeholder="추가 질문을 입력하세요..."
              rows="1"
            ></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">전송</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 전역 변수
    let currentConversationId = null;
    let conversations = [];
    let isTyping = false;

    // 초기화
    document.addEventListener('DOMContentLoaded', function() {
      loadConversations();
      loadDailyUpdates();
      loadWeeklyReports();
      setupEventListeners();
    });

    function setupEventListeners() {
      const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          startAnalysis();
        }
      });

      const chatInput = document.getElementById('chatInput');
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      const mainContainer = document.getElementById('mainContainer');
      
      sidebar.classList.add('active');
      overlay.classList.add('active');
      
      if (window.innerWidth > 768) {
        mainContainer.classList.add('sidebar-open');
      }
    }

    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      const mainContainer = document.getElementById('mainContainer');
      
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
      mainContainer.classList.remove('sidebar-open');
    }

    function startNewChat() {
      currentConversationId = null;
      showLandingPage();
      updateConversationHistory();
      closeSidebar();
    }

    // 홈으로 이동 함수 추가
    function goToHome() {
      currentConversationId = null;
      showLandingPage();
      closeSidebar();
    }

    function showLandingPage() {
      const landingPage = document.getElementById('landingPage');
      const chatPage = document.getElementById('chatPage');
      
      chatPage.classList.remove('active');
      setTimeout(() => {
        landingPage.classList.remove('hidden');
      }, 300);
    }

    function showChatPage() {
      const landingPage = document.getElementById('landingPage');
      const chatPage = document.getElementById('chatPage');
      
      landingPage.classList.add('hidden');
      setTimeout(() => {
        chatPage.classList.add('active');
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = '';
      }, 300);
    }

    function startAnalysis() {
      const searchInput = document.getElementById('searchInput');
      const query = searchInput.value.trim();
      
      if (!query) {
        alert('질문을 입력해주세요.');
        return;
      }
      
      showChatPage();
      setTimeout(() => {
        addMessage('user', query);
        callAnalysisAPI(query);
      }, 600);
    }

    function addMessage(type, content, animate = true) {
      const messagesContainer = document.getElementById('messagesContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const now = new Date();
      const timeString = now.toLocaleTimeString('ko-KR', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      messageDiv.innerHTML = `
        <div class="message-content">
          ${formatMessage(content)}
          <div class="message-time">${timeString}</div>
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      
      // 스크롤을 최하단으로
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTypingIndicator() {
      const messagesContainer = document.getElementById('messagesContainer');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message ai';
      typingDiv.id = 'typingIndicator';
      
      typingDiv.innerHTML = `
        <div class="typing-indicator">
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
          <span>RegWatch AI가 분석 중...</span>
        </div>
      `;
      
      messagesContainer.appendChild(typingDiv);
      
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      isTyping = true;
    }

    function hideTypingIndicator() {
      const typingIndicator = document.getElementById('typingIndicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
      isTyping = false;
    }

    function formatMessage(content) {
      return content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/##\s*(.*?)$/gm, '<h3 style="color: #0f2e69; margin: 20px 0 10px 0; font-size: 18px;">$1</h3>')
        .replace(/\n/g, '<br>');
    }

    function callAnalysisAPI(query) {
      showTypingIndicator();
      
      google.script.run
        .withSuccessHandler(onAnalysisSuccess)
        .withFailureHandler(onAnalysisFailure)
        .analyzeRegulation(query, currentConversationId);
    }

    function sendMessage() {
      const chatInput = document.getElementById('chatInput');
      const message = chatInput.value.trim();
      
      if (!message || isTyping) return;
      
      addMessage('user', message);
      chatInput.value = '';
      chatInput.style.height = 'auto';
      
      if (currentConversationId) {
        showTypingIndicator();
        google.script.run
          .withSuccessHandler(onAnalysisSuccess)
          .withFailureHandler(onAnalysisFailure)
          .continueConversation(currentConversationId, message);
      } else {
        callAnalysisAPI(message);
      }
    }

    function onAnalysisSuccess(result) {
      hideTypingIndicator();
      
      if (result.success) {
        let aiResponse = '';
        
        if (result.data && result.data.response) {
          aiResponse = result.data.response;
        } else if (result.data && result.data.message) {
          aiResponse = result.data.message;
        } else if (result.data) {
          aiResponse = JSON.stringify(result.data, null, 2);
        } else {
          aiResponse = '죄송합니다. 응답을 처리할 수 없습니다.';
        }
        
        addMessage('ai', aiResponse);
        
        if (result.conversation) {
          currentConversationId = result.conversation.id;
          loadConversations();
        }
      } else {
        addMessage('ai', '죄송합니다. 분석 중 오류가 발생했습니다. 다시 시도해주세요.');
      }
    }

    function onAnalysisFailure(error) {
      hideTypingIndicator();
      addMessage('ai', '죄송합니다. 서버와의 연결에 문제가 발생했습니다. 잠시 후 다시 시도해주세요.');
      console.error('API 호출 실패:', error);
    }

    function loadConversations() {
      google.script.run
        .withSuccessHandler(updateConversationHistory)
        .withFailureHandler(() => console.error('대화 히스토리 로드 실패'))
        .getConversations();
    }

    function updateConversationHistory(conversationList = []) {
      const historyContainer = document.getElementById('conversationHistory');
      historyContainer.innerHTML = '';
      
      conversations = conversationList;
      
      conversations.forEach((conv, index) => {
        const convDiv = document.createElement('div');
        convDiv.className = `conversation-item ${conv.id === currentConversationId ? 'active' : ''}`;
        convDiv.style.animationDelay = `${index * 0.1}s`;
        
        const timeAgo = getTimeAgo(new Date(conv.timestamp));
        
        convDiv.innerHTML = `
          <div class="conversation-title">${conv.title}</div>
          <div class="conversation-time">${timeAgo}</div>
          <button class="delete-conversation" onclick="deleteConversation('${conv.id}')" title="대화 삭제">×</button>
        `;
        
        convDiv.onclick = (e) => {
          if (e.target.classList.contains('delete-conversation')) return;
          loadConversation(conv.id);
        };
        
        historyContainer.appendChild(convDiv);
      });
    }

    function loadConversation(conversationId) {
      google.script.run
        .withSuccessHandler((conversation) => {
          if (conversation) {
            currentConversationId = conversationId;
            showChatPage();
            
            setTimeout(() => {
              const messagesContainer = document.getElementById('messagesContainer');
              messagesContainer.innerHTML = '';
              
              addMessage('user', conversation.userMessage, false);
              setTimeout(() => {
                addMessage('ai', conversation.aiResponse, false);
              }, 500);
              
              updateConversationHistory(conversations);
            }, 600);
            
            closeSidebar();
          }
        })
        .withFailureHandler(() => alert('대화를 불러올 수 없습니다.'))
        .getConversation(conversationId);
    }

    function deleteConversation(conversationId) {
      if (confirm('이 대화를 삭제하시겠습니까?')) {
        google.script.run
          .withSuccessHandler(() => {
            if (currentConversationId === conversationId) {
              currentConversationId = null;
              showLandingPage();
            }
            loadConversations();
          })
          .withFailureHandler(() => alert('대화 삭제에 실패했습니다.'))
          .deleteConversation(conversationId);
      }
    }

    // 데일리 업데이트 로드
    function loadDailyUpdates() {
      google.script.run
        .withSuccessHandler(renderDailyUpdates)
        .withFailureHandler(() => console.error('데일리 업데이트 로드 실패'))
        .getTodayUpdates();
    }

    function renderDailyUpdates(updates) {
      const container = document.getElementById('dailyUpdateCards');
      container.innerHTML = '';
      
      updates.forEach((update, index) => {
        const card = document.createElement('div');
        card.className = 'update-card';
        card.style.animationDelay = `${index * 0.1}s`;
        
        card.innerHTML = `
          <div class="card-header">
            <div class="card-category">${update.category}</div>
            <div class="card-impact ${update.impact === '높음' ? 'high' : 'medium'}">${update.impact}</div>
          </div>
          <div class="card-title">${update.title}</div>
          <div class="card-summary">${update.summary}</div>
          <div class="card-footer">
            <span class="effect-date">시행일: ${update.effectDate}</span>
            <span>출처: ${update.source}</span>
          </div>
        `;
        
        card.onclick = () => {
          showChatPage();
          setTimeout(() => {
            addMessage('user', `${update.title}에 대해 자세히 분석해주세요.`);
            callAnalysisAPI(`${update.title}에 대한 상세 분석과 투자 영향도를 알려주세요.`);
          }, 600);
        };
        
        container.appendChild(card);
      });
    }

    // 주간 보고서 로드
    function loadWeeklyReports() {
      google.script.run
        .withSuccessHandler(renderWeeklyReports)
        .withFailureHandler(() => console.error('주간 보고서 로드 실패'))
        .getWeeklyReports();
    }

    function renderWeeklyReports(reports) {
      const container = document.getElementById('weeklyReportList');
      container.innerHTML = '';
      
      reports.forEach((report, index) => {
        const item = document.createElement('div');
        item.className = 'report-item';
        item.style.animationDelay = `${index * 0.1}s`;
        
        item.innerHTML = `
          <div class="report-header">
            <div class="report-title">${report.title}</div>
            <div class="report-date">${report.date}</div>
          </div>
          <div class="report-summary">${report.summary}</div>
        `;
        
        item.onclick = () => {
          showChatPage();
          setTimeout(() => {
            addMessage('user', `${report.title}에 대해 자세히 알려주세요.`);
            callAnalysisAPI(`${report.title}의 주요 내용과 투자 시사점을 분석해주세요.`);
          }, 600);
        };
        
        container.appendChild(item);
      });
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return '방금 전';
      if (minutes < 60) return `${minutes}분 전`;
      if (hours < 24) return `${hours}시간 전`;
      if (days < 7) return `${days}일 전`;
      return date.toLocaleDateString('ko-KR');
    }

    function redirectToTool(tool) {
  closeSidebar();
  
  // 팀원들이 만든 페이지 URL 매핑
  const toolUrls = {
    'dashboard': 'https://script.google.com/a/macros/gnu.ac.kr/s/AKfycbwVLz0AI_twh3wK0hIiYdEqjqyRN9-mWH16VJ3tSP_AwcEkM1qs4Xqv2z7s6zXVeruuVg/exec',
    'reports': 'https://script.google.com/macros/s/AKfycbwEwqUB5r6dN31OX0Xdc_HQj2bf_rvhT5684p-4zE_v_v-JqlPrT8z9fI6YmibV7VEy/exec',
    'compare': 'https://script.google.com/macros/s/AKfycbycZzr5UufyZHlw1Ot6-lzwpo83BMCQ596w9j3zvLzKESIj0CR0UvDpiCHVLA3BKCJVQA/exec'
  };
  
  const targetUrl = toolUrls[tool];
  
  if (targetUrl) {
    // 새 탭에서 열기 (권장)
    window.open(targetUrl, '_blank');
  } else {
    console.error('해당 도구의 URL을 찾을 수 없습니다:', tool);
    alert('죄송합니다. 해당 페이지를 찾을 수 없습니다.');
  }
}


    function goToMyPage() {
      console.log('마이페이지로 이동');
      // 마이페이지 구현 예정
    }

    function logout() {
      if (confirm('로그아웃 하시겠습니까?')) {
        alert('로그아웃되었습니다.');
      }
    }

    // 반응형 처리
    window.addEventListener('resize', function() {
      const mainContainer = document.getElementById('mainContainer');
      const sidebar = document.getElementById('sidebar');
      
      if (window.innerWidth <= 768) {
        mainContainer.classList.remove('sidebar-open');
      } else if (sidebar.classList.contains('active')) {
        mainContainer.classList.add('sidebar-open');
      }
    });
  </script>
</body>
</html>
