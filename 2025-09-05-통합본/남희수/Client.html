<script>
  const $ = s => document.querySelector(s);
  let selectedSector = 'solar';
  let isAnalyzing = false;
  let currentData = [];

  (function init(){
    // ì„¹í„° ë“œë¡­ë‹¤ìš´
    const sel = $('#sector');
    (PAYLOAD.sectors||[]).forEach(s=>{
      const o=document.createElement('option'); 
      o.value=s; 
      o.textContent=PAYLOAD.sectorLabels?.[s]||s; 
      sel.appendChild(o);
    });
    sel.value = selectedSector;
    sel.addEventListener('change', ()=>{ 
      selectedSector = sel.value; 
      updateCaption();
      // ì„¹í„° ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ìƒˆ ë°ì´í„° ë¡œë“œ
      startAnalysis();
    });

    // ê²€ìƒ‰ì°½ Enter
    $('#query').addEventListener('keydown', e=>{ 
      if(e.key==='Enter'){ e.preventDefault(); startAnalysis(); }
    });

    updateCaption();
    
    // ìë™ ì‹œì‘
    setTimeout(startAnalysis, 1000);
  })();

  function updateCaption() {
    const name = PAYLOAD.sectorLabels?.[selectedSector] || selectedSector;
    $('#sector-caption').textContent = `${name} ë¶„ì•¼ì˜ êµ­ê°€ë³„ ê·œì œ í˜„í™©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¹„êµë¶„ì„í•©ë‹ˆë‹¤.`;
  }

  function switchTab(el){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    const k = el.getAttribute('data-tab');
    ['overview','compliance'].forEach(key=>{
      $('#panel-'+key).style.display = (k===key)?'block':'none';
    });
  }

  function showStatus(msg, type='loading') {
    const status = $('#status');
    const text = $('#statusText');
    text.textContent = msg;
    status.className = `status ${type}`;
    status.style.display = 'flex';
  }

  function hideStatus() {
    $('#status').style.display = 'none';
  }

  function startAnalysis() {
    if (isAnalyzing) return;
    
    isAnalyzing = true;
    const btn = $('#searchBtn');
    btn.disabled = true;
    btn.textContent = 'ë¶„ì„ ì¤‘...';
    
    const sectorName = PAYLOAD.sectorLabels?.[selectedSector] || selectedSector;
    showStatus(`${sectorName} ë¶„ì•¼ ê·œì œ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...`, 'loading');
    
    const query = $('#query').value.trim();
    
    google.script.run
      .withSuccessHandler(handleSuccess)
      .withFailureHandler(handleError)
      .fetchRegulationData(selectedSector, query);
  }

  function handleSuccess(result) {
    isAnalyzing = false;
    const btn = $('#searchBtn');
    btn.disabled = false;
    btn.textContent = 'ê²€ìƒ‰';
    
    if (result.success) {
      showStatus(`âœ… ${result.summary}`, 'success');
      setTimeout(hideStatus, 3000);
      
      currentData = result.rows || [];
      renderTable(currentData);
      renderCompliance(currentData);
    } else {
      showStatus(`âš ï¸ ${result.summary}`, 'error');
      currentData = [];
    }
  }

  function handleError(error) {
    isAnalyzing = false;
    const btn = $('#searchBtn');
    btn.disabled = false;
    btn.textContent = 'ê²€ìƒ‰';
    
    showStatus(`âŒ ì˜¤ë¥˜: ${error.message || error}`, 'error');
    currentData = [];
  }

  function renderTable(rows) {
    const tbody = $('#main-table tbody');
    tbody.innerHTML = '';
    
    if (!rows || rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:3rem; color:var(--muted);">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      return;
    }
    
    rows.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${escapeHtml(row.country)}</strong></td>
        <td><span class="chip">${escapeHtml(row.region)}</span></td>
        <td style="max-width:300px; font-weight:600; color:var(--brand-navy);">${escapeHtml(row.reportTitle || 'N/A')}</td>
        <td><div class="regulation-summary">${escapeHtml(row.requirements)}</div></td>
        <td><a href="${escapeHtml(row.sourceUrl || '#')}" target="_blank" class="btn-link">ì›ë¬¸ ë³´ê¸°</a></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderCompliance(rows) {
    const container = $('#compliance-content');
    
    if (!rows || rows.length === 0) {
      container.innerHTML = '<div class="compliance-item"><h4>ë°ì´í„° ì—†ìŒ</h4><p>ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ë©´ ì»´í”Œë¼ì´ì–¸ìŠ¤ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p></div>';
      return;
    }
    
    container.innerHTML = rows.map(row => `
      <div class="compliance-item">
        <h4>${escapeHtml(row.country)} (${escapeHtml(row.region)})</h4>
        <div class="report-title">${escapeHtml(row.reportTitle || 'N/A')}</div>
        <div class="compliance-meta">
          <span>ğŸ“… ë³´ê³ ì„œ ì‘ì„±ì¼: ${escapeHtml(row.reportDate || 'N/A')}</span>
          <span>âš¡ ê·œì œ ë°œíš¨ì¼: ${escapeHtml(row.effectiveDate || 'N/A')}</span>
          <span>ğŸ¢ ì‘ì„±ê¸°ê´€: ${escapeHtml(row.source || 'N/A')}</span>
        </div>
        <p style="margin:0; line-height:1.6; color:var(--fg);">${escapeHtml(row.requirements)}</p>
      </div>
    `).join('');
  }

  function resetData() {
    $('#query').value = '';
    hideStatus();
    currentData = [];
    $('#main-table tbody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:3rem; color:var(--muted);">ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ê²€ìƒ‰ì„ ì‹œì‘í•˜ì„¸ìš”.</td></tr>';
    $('#compliance-content').innerHTML = '<div class="compliance-item"><h4>ë°ì´í„° ì—†ìŒ</h4><p>ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ë©´ ì»´í”Œë¼ì´ì–¸ìŠ¤ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p></div>';
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
</script>
