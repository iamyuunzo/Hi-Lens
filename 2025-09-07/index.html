<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
      @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css');
      :root { --main-bg: #f8f9fa; --card-bg: #ffffff; --text-primary: #212529; --text-secondary: #6c757d; --key-color-1: #dc8d32; --key-color-2: #0f2e69; --border-color: #dee2e6; --font-family: 'Pretendard', sans-serif; }
      body { font-family: var(--font-family); background-color: var(--main-bg); color: var(--text-primary); margin: 0; padding: 2rem; }
      .container { max-width: 1200px; margin: 0 auto; }
      .header { margin-bottom: 2rem; }
      .header-top { display: flex; justify-content: space-between; align-items: flex-start; }
      .header h1 { font-size: 2rem; font-weight: 700; color: var(--key-color-2); margin-bottom: 0.5rem; }
      .header p { color: var(--text-secondary); margin-top: 0; }
      #crawlButton { font-family: var(--font-family); font-size: 1rem; font-weight: 600; background-color: var(--key-color-1); color: white; border: none; border-radius: 8px; padding: 0.8rem 1.5rem; cursor: pointer; transition: background-color 0.2s; }
      #crawlButton:disabled { background-color: #ccc; cursor: not-allowed; }
      #crawlStatus { font-size: 0.9rem; color: var(--text-secondary); height: 20px; margin-top: 0.5rem;}
      .search-bar { display: flex; gap: 1rem; margin-top: 1.5rem; }
      .search-bar input { flex-grow: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
      .search-bar button { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; background-color: var(--key-color-2); color: white; font-size: 1rem; cursor: pointer; }
      .section { margin-bottom: 3rem; }
      .section-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; }
      .section-header h2 { font-size: 1.5rem; font-weight: 600; margin: 0; }
      .tag { background-color: var(--key-color-1); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.9rem; font-weight: 500; }
      .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
      .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 0.75rem; }
      .card-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-secondary); }
      .card-category { background-color: #e9ecef; padding: 0.2rem 0.6rem; border-radius: 8px; font-weight: 500; color: var(--key-color-2); }
      .card-title { font-size: 1.1rem; font-weight: 600; margin: 0; }
      .card-summary { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; }
      .card-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; }
      .impact-badge { padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem; font-weight: 700; }
      .impact-badge.high { background-color: #fff5f5; color: #e53e3e; } .impact-badge.medium { background-color: #fffbeb; color: #f59e0b; } .impact-badge.low { background-color: #f0fdf4; color: #16a34a; }
      .card-link a { text-decoration: none; color: var(--key-color-1); font-weight: 500; font-size: 0.9rem; }
      .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; }
      .stat-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; }
      .stat-card .label { font-size: 1rem; color: var(--text-secondary); }
      .stat-card .value { font-size: 2.5rem; font-weight: 700; color: var(--key-color-2); margin: 0.5rem 0; }
    </style>
</head>
<body>
    <div class="container">
      <header class="header">
        <div class="header-top">
          <div>
            <h1>ì¸í”„ë¼ íˆ¬ì ë™í–¥ ëŒ€ì‹œë³´ë“œ</h1>
            <p>ì¸í”„ë¼ íˆ¬ì ê´€ë ¨ ì£¼ìš” ê·œì œ ë° ì •ì±… ë³€ê²½ì‚¬í•­ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ê³  ë¶„ì„í•˜ì„¸ìš”.</p>
          </div>
          <div>
            <button id="crawlButton">ğŸ”„ ì‹¤ì‹œê°„ ì •ë³´ ì—…ë°ì´íŠ¸</button>
            <p id="crawlStatus"></p>
          </div>
        </div>
        <div class="search-bar"><input type="text" id="searchInput" placeholder="ë³´ê³ ì„œ ì œëª©, ì¹´í…Œê³ ë¦¬, ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰..."><button id="searchButton">ê²€ìƒ‰</button></div>
      </header>
      <section class="section" id="search-results-section" style="display: none;"><div class="section-header"><h2 id="search-results-title">ê²€ìƒ‰ ê²°ê³¼</h2></div><div class="card-grid" id="search-results-grid"></div></section>
      <section class="section" id="today-section"><div class="section-header"><h2>ì˜¤ëŠ˜ì˜ ì£¼ìš” ë³€ê²½ì‚¬í•­</h2><span class="tag" id="today-count">0</span></div><div class="card-grid" id="today-grid"><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div></section>
      <section class="section"><div class="stats-grid" id="stats-grid"><div class="stat-card"><div class="label">ì „ì²´ ë³´ê³ ì„œ</div><div class="value" id="total-reports">0</div></div><div class="stat-card"><div class="label">ì‹ ê·œ ì—…ë°ì´íŠ¸ (ì˜¤ëŠ˜)</div><div class="value" id="new-updates">0</div></div><div class="stat-card"><div class="label">ë†’ì€ ì„íŒ©íŠ¸</div><div class="value" id="high-impact">0</div></div><div class="stat-card"><div class="label">ë¶„ì„ ì¹´í…Œê³ ë¦¬</div><div class="value" id="total-categories">0</div></div></div></section>
      <section class="section"><div class="section-header"><h2 id="recent-title">ìµœê·¼ ë³´ê³ ì„œ</h2></div><div class="card-grid" id="recent-grid"></div></section>
    </div>
    <script>
      // <<<--- ì›¹ ì•± ë¡œì§ ì‹œì‘ --->>>
      document.addEventListener('DOMContentLoaded', loadDashboard);
      document.getElementById('searchButton').addEventListener('click', handleSearch);
      document.getElementById('searchInput').addEventListener('keyup', (event) => { if (event.key === 'Enter') handleSearch(); });
      document.getElementById('crawlButton').addEventListener('click', handleCrawl);

      function handleCrawl() {
        const crawlButton = document.getElementById('crawlButton');
        const crawlStatus = document.getElementById('crawlStatus');
        
        crawlButton.disabled = true;
        crawlStatus.textContent = 'ì—…ë°ì´íŠ¸ ì¤‘... (ìµœëŒ€ 1-2ë¶„ ì†Œìš”)';
        
        google.script.run
          .withSuccessHandler(onCrawlSuccess)
          .withFailureHandler(showError)
          .runCrawlingFromWebApp();
      }

      function onCrawlSuccess(message) {
        const crawlButton = document.getElementById('crawlButton');
        const crawlStatus = document.getElementById('crawlStatus');

        crawlStatus.textContent = message;
        crawlButton.disabled = false;
        
        // ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ í™”ë©´ì„ ê°±ì‹ í•©ë‹ˆë‹¤.
        loadDashboard();

        // 5ì´ˆ í›„ì— ìƒíƒœ ë©”ì‹œì§€ë¥¼ ì§€ì›ë‹ˆë‹¤.
        setTimeout(() => { crawlStatus.textContent = ''; }, 5000);
      }
      
      function loadDashboard() { google.script.run.withSuccessHandler(updateUI).withFailureHandler(showError).getDashboardData(); }
      function updateUI(data) {
        const todayGrid = document.getElementById('today-grid');
        document.getElementById('today-count').textContent = data.stats.today;
        todayGrid.innerHTML = data.todayReports.length > 0 ? data.todayReports.map(r => createCard(r, true)).join('') : "<p>ì˜¤ëŠ˜ì˜ ì‹ ê·œ ì—…ë°ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        document.getElementById('total-reports').textContent = data.stats.total;
        document.getElementById('new-updates').textContent = data.stats.today;
        document.getElementById('high-impact').textContent = data.stats.highImpact;
        document.getElementById('total-categories').textContent = data.stats.categories;
        document.getElementById('recent-grid').innerHTML = data.recentReports.map(r => createCard(r, false)).join('');
      }
      function handleSearch() {
        const searchTerm = document.getElementById('searchInput').value, searchSection = document.getElementById('search-results-section'), searchGrid = document.getElementById('search-results-grid'), searchTitle = document.getElementById('search-results-title');
        if (!searchTerm) { searchSection.style.display = 'none'; return; }
        searchSection.style.display = 'block'; searchGrid.innerHTML = "<p>ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</p>"; searchTitle.textContent = `'${searchTerm}' ê²€ìƒ‰ ê²°ê³¼`;
        google.script.run.withSuccessHandler(results => { searchGrid.innerHTML = results.length > 0 ? results.map(r => createCard(r, false)).join('') : "<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"; }).withFailureHandler(showError).searchReports(searchTerm);
      }
      function showError(error) { 
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message); 
        const crawlButton = document.getElementById('crawlButton');
        const crawlStatus = document.getElementById('crawlStatus');
        crawlButton.disabled = false;
        crawlStatus.textContent = 'ì˜¤ë¥˜ ë°œìƒ. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      }
      function createCard(report, isNew) {
        let impactClass = 'low'; if (report.impactLevel === 'ë†’ìŒ') impactClass = 'high'; else if (report.impactLevel === 'ì¤‘ê°„') impactClass = 'medium';
        return `<div class="card"><div class="card-header"><span class="card-category">${report.category}</span>${isNew ? `<span>âœ¨ ì‹ ê·œ</span>` : ''}</div><h3 class="card-title">${report.title}</h3><p class="card-summary">${report.summary}</p><div class="card-footer"><span class="impact-badge ${impactClass}">${report.impactLevel} ì„íŒ©íŠ¸</span><span class="card-link"><a href="${report.sourceURL}" target="_blank">ì›ë¬¸ ë³´ê¸° &rarr;</a></span></div></div>`;
      }
    </script>
</body>
</html>
